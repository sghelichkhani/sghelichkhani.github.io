<div class="publications-list" itemscope itemtype="https://schema.org/ItemList">
  {{ $publications := .Site.Data.publications }}
  {{/* Build a slice with year extracted for proper sorting */}}
  {{ $pubsWithYear := slice }}
  {{ range $publications }}
    {{ $year := index (index (index .issued "date-parts") 0) 0 | default 0 }}
    {{ $pubsWithYear = $pubsWithYear | append (dict "year" $year "pub" .) }}
  {{ end }}
  {{/* Sort by year descending */}}
  {{ $sortedPubs := sort $pubsWithYear "year" "desc" }}
  {{ range $index, $item := $sortedPubs }}
  {{ $pub := .pub }}
  {{ $year := .year }}
  <div class="publication-item" itemscope itemtype="https://schema.org/ScholarlyArticle" itemprop="itemListElement">
    <meta itemprop="position" content="{{ add $index 1 }}">
    {{ if $pub.DOI }}<meta itemprop="identifier" content="doi:{{ $pub.DOI }}">{{ end }}
    {{ if $year }}<meta itemprop="datePublished" content="{{ $year }}">{{ end }}
    <ul>
      <li>
        <!-- Authors -->
        <span class="authors" itemprop="author">
          {{ $authors := slice }}
          {{ range $pub.author }}
            {{ if .literal }}
              {{ $authors = $authors | append .literal }}
            {{ else }}
              {{ $authors = $authors | append (printf "%s. %s" (substr .given 0 1) .family) }}
            {{ end }}
          {{ end }}
          {{ delimit $authors ", " " and " }}
        </span>

        <!-- Year -->
        {{ if $year }}
        <span class="year">
          ({{ $year }})
        </span>
        {{ end }}

        <!-- Title -->
        <span class="title" itemprop="headline">
          {{ if $pub.URL }}
            <a href="{{ $pub.URL }}" target="_blank" itemprop="url">{{ $pub.title }}</a>
          {{ else }}
            {{ $pub.title }}
          {{ end }}
        </span>

        <!-- Journal/Container -->
        {{ if index $pub "container-title" }}
        <span class="journal" itemprop="isPartOf" itemscope itemtype="https://schema.org/Periodical">
          <em itemprop="name">{{ index $pub "container-title" }}</em>{{ if $pub.volume }}, <span itemprop="volumeNumber">{{ $pub.volume }}</span>{{ end }}{{ if $pub.issue }}(<span itemprop="issueNumber">{{ $pub.issue }}</span>){{ end }}{{ if $pub.page }}, <span itemprop="pagination">{{ $pub.page }}</span>{{ end }}
        </span>
        {{ end }}

        <!-- DOI -->
        {{ if $pub.DOI }}
        <span class="doi">
          DOI: <a href="https://doi.org/{{ $pub.DOI }}" target="_blank" itemprop="sameAs">{{ $pub.DOI }}</a>
        </span>
        {{ end }}

        <!-- Copy BibTeX Button -->
        <button class="copy-bibtex-btn" onclick="copyBibTeX({{ $index }})" title="Copy BibTeX">
          ðŸ“‹
        </button>

        <!-- Hidden BibTeX data -->
        <script type="application/json" id="bibtex-{{ $index }}">
        {{ $bibtex := "" }}
        {{ $bibtex = printf "@article{%s," ($pub.id | default (printf "publication%d" $index)) }}
        {{ $bibtex = printf "%s\n  title = {%s}," $bibtex $pub.title }}
        {{ if $pub.author }}
          {{ $authorStr := "" }}
          {{ $authorLen := len $pub.author }}
          {{ range $i, $author := $pub.author }}
            {{ if .literal }}
              {{ $authorStr = printf "%s%s" $authorStr .literal }}
            {{ else }}
              {{ $authorStr = printf "%s%s, %s" $authorStr .family .given }}
            {{ end }}
            {{ if lt $i (sub $authorLen 1) }}{{ $authorStr = printf "%s and " $authorStr }}{{ end }}
          {{ end }}
          {{ $bibtex = printf "%s\n  author = {%s}," $bibtex $authorStr }}
        {{ end }}
        {{ if index $pub "container-title" }}
          {{ $bibtex = printf "%s\n  journal = {%s}," $bibtex (index $pub "container-title") }}
        {{ end }}
        {{ if $pub.volume }}
          {{ $bibtex = printf "%s\n  volume = {%s}," $bibtex $pub.volume }}
        {{ end }}
        {{ if $pub.issue }}
          {{ $bibtex = printf "%s\n  number = {%s}," $bibtex $pub.issue }}
        {{ end }}
        {{ if $pub.page }}
          {{ $bibtex = printf "%s\n  pages = {%s}," $bibtex $pub.page }}
        {{ end }}
        {{ if $year }}
          {{ $bibtex = printf "%s\n  year = {%s}," $bibtex $year }}
        {{ end }}
        {{ if $pub.DOI }}
          {{ $bibtex = printf "%s\n  doi = {%s}," $bibtex $pub.DOI }}
        {{ end }}
        {{ if $pub.URL }}
          {{ $bibtex = printf "%s\n  url = {%s}," $bibtex $pub.URL }}
        {{ end }}
        {{ $bibtex = printf "%s\n}" $bibtex }}
        {{ $bibtex | jsonify }}
        </script>
      </li>
    </ul>
  </div>
  {{ end }}
</div>

<script>
function copyBibTeX(index) {
  const bibtexElement = document.getElementById(`bibtex-${index}`);
  const bibtexData = JSON.parse(bibtexElement.textContent);

  navigator.clipboard.writeText(bibtexData).then(() => {
    // Visual feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'âœ…';
    button.style.color = 'green';

    setTimeout(() => {
      button.textContent = originalText;
      button.style.color = '';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy: ', err);
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = bibtexData;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  });
}
</script>

<style>
.copy-bibtex-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  margin-left: 10px;
  padding: 2px 5px;
  border-radius: 3px;
  transition: background-color 0.2s;
}

.copy-bibtex-btn:hover {
  background-color: #f0f0f0;
}
</style>
